<!DOCTYPE html>
<html lang="pt-BR" id="html-lang">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="app_title">Triagem Gineco-Obstetr√≠cia (GOB) ‚Äî MissionCare Plus</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;800&family=Noto+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  
  <!-- Chosen Palette: Clinical Teal & Slate (MissionCare+ Identity) -->
  <!-- Application Structure Plan: A guided, multi-screen flow was implemented based on the approved proposal. It starts with large, clear profile selection boxes to simplify the initial choice. This leads to a sequential process (Vitals -> Symptoms -> Result), with a persistent "Patient Card" at the top to keep critical context (Profile, Gestational Age) visible. This structure is superior for field use as it minimizes cognitive load and guides even infrequent users through the protocol correctly. -->
  <!-- Visualization & Content Choices: The application uses interactive UI cards and forms. Goal: Guided Risk Stratification with quick actions. Method: The "C√≥digo Mater" button was updated to a "Comunicar Emerg√™ncia" button linking to WhatsApp with a pre-formatted message. A multi-language system (JS i18n object) was added with UI buttons for on-the-fly translation. Justification: These features enhance usability and actionability, aligning with the project's real-world needs for multilingual support and modern communication channels. Library: Vanilla JS. -->
  <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

  <meta name="theme-color" content="#0f766e"/>
  <style>
    body { font-family: 'Noto Sans', sans-serif; }
    h1, h2, h3, button, .font-semibold, .font-extrabold { font-family: 'Lexend', sans-serif; }
    .page {
        display: none;
        animation: fadeIn 0.5s;
    }
    .page.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .profile-box {
        transition: all 0.2s ease-in-out;
    }
    .profile-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .lang-btn.active {
        color: #0f766e;
        font-weight: 800;
        text-decoration: underline;
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
  <main class="max-w-3xl mx-auto p-4 sm:p-6">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-extrabold text-teal-800" data-i18n="main_title">Triagem Gineco-Obstetr√≠cia</h1>
      <p class="text-sm text-slate-600 mt-2" data-i18n="subtitle">
        Ferramenta de apoio √† decis√£o. <strong>N√£o substitui uma consulta m√©dica.</strong>
      </p>
      <div id="lang-switcher" class="flex justify-center gap-4 mt-4">
        <button onclick="setLanguage('pt')" class="lang-btn text-sm font-semibold text-slate-600 hover:text-teal-700" data-lang="pt">üáßüá∑ Portugu√™s</button>
        <button onclick="setLanguage('es')" class="lang-btn text-sm font-semibold text-slate-600 hover:text-teal-700" data-lang="es">üá™üá∏ Espa√±ol</button>
        <button onclick="setLanguage('en')" class="lang-btn text-sm font-semibold text-slate-600 hover:text-teal-700" data-lang="en">üá∫üá∏ English</button>
      </div>
    </header>

    <!-- Page 1: Profile Selection -->
    <div id="page-1" class="page active">
        <h2 class="font-semibold text-lg text-slate-800 text-center mb-4" data-i18n="select_profile_title">1. Selecione o Perfil da Paciente</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            <div onclick="selectProfile('gestante')" class="profile-box bg-white shadow-md rounded-2xl p-6 text-center cursor-pointer">
                <span class="text-6xl">ü§∞</span>
                <p class="text-xl font-semibold mt-4" data-i18n="profile_gestante">Gestante</p>
            </div>
            <div onclick="selectProfile('puerpera')" class="profile-box bg-white shadow-md rounded-2xl p-6 text-center cursor-pointer">
                <span class="text-6xl">ü§±</span>
                <p class="text-xl font-semibold mt-4" data-i18n="profile_puerpera">Pu√©rpera</p>
                <span class="text-xs text-slate-500" data-i18n="profile_puerpera_subtitle">(at√© 42 dias p√≥s-parto)</span>
            </div>
            <div onclick="selectProfile('nao_gravida')" class="profile-box bg-white shadow-md rounded-2xl p-6 text-center cursor-pointer">
                <span class="text-6xl">üë©‚Äç‚öïÔ∏è</span>
                <p class="text-xl font-semibold mt-4" data-i18n="profile_nao_gravida">N√£o Gr√°vida</p>
            </div>
        </div>
    </div>

    <!-- Page 2: Data Input -->
    <div id="page-2" class="page">
        <!-- Patient Quick Card -->
        <div id="patient-card" class="bg-teal-700 text-white rounded-2xl p-4 mb-5 shadow-lg sticky top-4 z-10">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-semibold text-lg"><span data-i18n="card_profile">Perfil</span>: <span id="card-profile"></span></p>
                    <p id="card-ig-container" class="text-sm hidden"><span data-i18n="card_gestational_age">Idade Gestacional</span>: <span id="card-ig" class="font-bold"></span></p>
                </div>
                <button onclick="resetApp()" class="text-sm underline hover:text-teal-200" data-i18n="change_profile">Trocar Perfil</button>
            </div>
        </div>

        <!-- Gestante Fields -->
        <div id="gestante-fields-section" class="bg-white shadow-md rounded-2xl p-5 mb-5 hidden">
            <h3 class="font-semibold text-lg text-slate-800 mb-3" data-i18n="gestational_age_title">Idade Gestacional</h3>
             <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label for="dum" class="block text-sm font-medium text-slate-700" data-i18n="dum_label">DUM (data da √∫ltima menstrua√ß√£o)</label>
                <input type="date" id="dum" class="w-full mt-1 rounded-lg border-slate-300 focus:border-teal-500 focus:ring-teal-500">
              </div>
              <div>
                <label for="igSemanas" class="block text-sm font-medium text-slate-700" data-i18n="ig_weeks_label">IG em semanas (se n√£o souber a DUM)</label>
                <input type="number" id="igSemanas" class="w-full mt-1 rounded-lg border-slate-300 focus:border-teal-500 focus:ring-teal-500" min="4" max="43" placeholder="ex.: 28">
              </div>
            </div>
        </div>

        <!-- Vitals -->
        <div class="bg-white shadow-md rounded-2xl p-5 mb-5">
            <h3 class="font-semibold text-lg text-slate-800 mb-3" data-i18n="vitals_title">Sinais Vitais (Opcional)</h3>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                <div>
                  <label for="pas" class="block text-sm font-medium text-slate-600">PAS</label>
                  <input id="pas" type="number" class="w-full mt-1 rounded-lg border-slate-300" placeholder="mmHg">
                </div>
                <div>
                  <label for="pad" class="block text-sm font-medium text-slate-600">PAD</label>
                  <input id="pad" type="number" class="w-full mt-1 rounded-lg border-slate-300" placeholder="mmHg">
                </div>
                <div>
                  <label for="fc" class="block text-sm font-medium text-slate-600">FC</label>
                  <input id="fc" type="number" class="w-full mt-1 rounded-lg border-slate-300" placeholder="bpm">
                </div>
                <div>
                  <label for="fr" class="block text-sm font-medium text-slate-600">FR</label>
                  <input id="fr" type="number" class="w-full mt-1 rounded-lg border-slate-300" placeholder="irpm">
                </div>
                <div>
                  <label for="temp" class="block text-sm font-medium text-slate-600">Temp</label>
                  <input id="temp" type="number" step="0.1" class="w-full mt-1 rounded-lg border-slate-300" placeholder="¬∞C">
                </div>
            </div>
        </div>

        <!-- Symptoms -->
        <div class="bg-white shadow-md rounded-2xl p-5 mb-5">
            <h3 class="font-semibold text-lg text-slate-800 mb-3" data-i18n="symptoms_title">Sinais e Sintomas de Alerta</h3>
            <div class="grid sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="sangramento_intenso"><span data-i18n="symptom_bleeding">Sangramento vaginal intenso/co√°gulos</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="dor_abdominal_forte"><span data-i18n="symptom_pain">Dor abdominal forte/contra√ß√µes regulares</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="perda_liquido"><span data-i18n="symptom_fluid_loss">Perda de l√≠quido pela vagina</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="cefaleia_visao"><span data-i18n="symptom_headache">Cefaleia forte/vis√£o turva</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="convulsao"><span data-i18n="symptom_seizure">Convuls√£o/desmaio</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="dispneia_toracica"><span data-i18n="symptom_breathing">Falta de ar/dor tor√°cica</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="febre_alta"><span data-i18n="symptom_fever">Febre alta/calafrios</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="disuria_lombar"><span data-i18n="symptom_urinary_pain">Dor ao urinar/dor lombar</span></label>
                <label class="flex items-center gestanteOnly hidden"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="mov_fetais_reduzidos"><span data-i18n="symptom_fetal_mov">Movimentos fetais reduzidos (se ‚â•24 sem)</span></label>
                <label class="flex items-center gestanteOnly hidden"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="ombro_dor"><span data-i18n="symptom_shoulder_pain">Dor no ombro/tontura (suspeita de ect√≥pica)</span></label>
                <label class="flex items-center puerperaOnly hidden"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="sangramento_puerperio"><span data-i18n="symptom_postpartum_bleeding">Sangramento anormal no puerp√©rio</span></label>
                <label class="flex items-center puerperaOnly hidden"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="mastite"><span data-i18n="symptom_mastitis">Mama vermelha/dolorosa com febre (mastite)</span></label>
                <label class="flex items-center"><input type="checkbox" class="mr-2 rounded text-teal-600 focus:ring-teal-500 sym" value="vomitos_persistentes"><span data-i18n="symptom_vomiting">V√¥mitos persistentes/incapaz de ingerir l√≠quidos</span></label>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 mt-6 items-center">
            <button id="analisarBtn" class="px-6 py-3 rounded-xl bg-teal-700 text-white font-semibold shadow-lg hover:bg-teal-800 transition-all transform hover:scale-105" tabindex="0" data-i18n="analyze_button">Analisar Sinais</button>
        </div>
    </div>

    <!-- Page 3: Result -->
    <div id="page-3" class="page">
        <section id="resultado" class="rounded-2xl p-5 border-4">
            <div id="nivel" class="text-2xl font-extrabold mb-3 flex items-center"></div>
            <h3 class="font-semibold text-slate-800 mb-2" data-i18n="result_advice_title">Aconselhamento e Plano de A√ß√£o:</h3>
            <div id="aconselhamento" class="mt-2 text-sm leading-relaxed space-y-2"></div>
            
            <!-- Emergency Actions -->
            <div id="emergency-actions" class="mt-5 space-y-3 hidden">
                <a id="comunicar-emergencia-btn" href="#" target="_blank" class="block w-full text-center px-4 py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-colors">
                    <span data-i18n="emergency_button">üö® COMUNICAR EMERG√äNCIA</span>
                </a>
                <a href="#" class="block w-full text-center px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-300 transition-colors" data-i18n="guide_hemorrhage">
                    Ver Guia R√°pido: Hemorragia
                </a>
            </div>
            
            <!-- Other Actions -->
            <div id="other-actions" class="mt-4 space-y-2 hidden">
                 <a href="#" class="block w-full text-center px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-300 transition-colors" data-i18n="guide_preeclampsia">
                    Ver Guia R√°pido: Pr√©-ecl√¢mpsia
                </a>
            </div>

            <details class="mt-6">
                <summary class="cursor-pointer text-sm font-semibold text-slate-600 hover:text-slate-800" data-i18n="summary_title">Ver resumo para registro</summary>
                <pre id="resumo" class="mt-2 text-xs bg-slate-100 p-3 rounded-lg overflow-x-auto"></pre>
            </details>
            <div class="mt-4 flex flex-wrap gap-3">
                <button id="copiarBtn" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-semibold hover:bg-slate-700 transition-colors" data-i18n="copy_summary_button">Copiar Resumo</button>
                <button onclick="resetApp()" class="px-4 py-2 bg-teal-700 text-white rounded-lg text-sm font-semibold hover:bg-teal-600 transition-colors" data-i18n="new_triage_button">Nova Triagem</button>
            </div>
        </section>
    </div>
  </main>

  <script>
    const el = id => document.getElementById(id);
    const state = { profile: null, ig: null, summary: '' };
    const pages = {
        '1': el('page-1'),
        '2': el('page-2'),
        '3': el('page-3'),
    };
    const profileLabels = {
        pt: { gestante: 'Gestante', puerpera: 'Pu√©rpera', nao_gravida: 'N√£o Gr√°vida' },
        es: { gestante: 'Gestante', puerpera: 'Pu√©rpera', nao_gravida: 'No Embarazada' },
        en: { gestante: 'Pregnant', puerpera: 'Postpartum', nao_gravida: 'Not Pregnant' }
    };

    const translations = {
        pt: {
            app_title: "Triagem Gineco-Obstetr√≠cia (GOB) ‚Äî MissionCare Plus",
            main_title: "Triagem Gineco-Obstetr√≠cia",
            subtitle: "Ferramenta de apoio √† decis√£o. <strong>N√£o substitui uma consulta m√©dica.</strong>",
            select_profile_title: "1. Selecione o Perfil da Paciente",
            profile_gestante: "Gestante",
            profile_puerpera: "Pu√©rpera",
            profile_puerpera_subtitle: "(at√© 42 dias p√≥s-parto)",
            profile_nao_gravida: "N√£o Gr√°vida",
            card_profile: "Perfil",
            card_gestational_age: "Idade Gestacional",
            change_profile: "Trocar Perfil",
            gestational_age_title: "Idade Gestacional",
            dum_label: "DUM (data da √∫ltima menstrua√ß√£o)",
            ig_weeks_label: "IG em semanas (se n√£o souber a DUM)",
            vitals_title: "Sinais Vitais (Opcional)",
            symptoms_title: "Sinais e Sintomas de Alerta",
            analyze_button: "Analisar Sinais",
            result_advice_title: "Aconselhamento e Plano de A√ß√£o:",
            emergency_button: "üö® COMUNICAR EMERG√äNCIA",
            guide_hemorrhage: "Ver Guia R√°pido: Hemorragia",
            guide_preeclampsia: "Ver Guia R√°pido: Pr√©-ecl√¢mpsia",
            summary_title: "Ver resumo para registro",
            copy_summary_button: "Copiar Resumo",
            new_triage_button: "Nova Triagem",
            copied: "Copiado!",
            symptom_bleeding: "Sangramento vaginal intenso/co√°gulos",
            symptom_pain: "Dor abdominal forte/contra√ß√µes regulares",
            symptom_fluid_loss: "Perda de l√≠quido pela vagina",
            symptom_headache: "Cefaleia forte/vis√£o turva",
            symptom_seizure: "Convuls√£o/desmaio",
            symptom_breathing: "Falta de ar/dor tor√°cica",
            symptom_fever: "Febre alta/calafrios",
            symptom_urinary_pain: "Dor ao urinar/dor lombar",
            symptom_fetal_mov: "Movimentos fetais reduzidos (se ‚â•24 sem)",
            symptom_shoulder_pain: "Dor no ombro/tontura (suspeita de ect√≥pica)",
            symptom_postpartum_bleeding: "Sangramento anormal no puerp√©rio",
            symptom_mastitis: "Mama vermelha/dolorosa com febre (mastite)",
            symptom_vomiting: "V√¥mitos persistentes/incapaz de ingerir l√≠quidos",
        },
        es: {
            app_title: "Triaje Obst√©trico y Ginecol√≥gico ‚Äî MissionCare Plus",
            main_title: "Triaje Obst√©trico y Ginecol√≥gico",
            subtitle: "Herramienta de apoyo a la decisi√≥n. <strong>No reemplaza una consulta m√©dica.</strong>",
            select_profile_title: "1. Seleccione el Perfil de la Paciente",
            profile_gestante: "Gestante",
            profile_puerpera: "Pu√©rpera",
            profile_puerpera_subtitle: "(hasta 42 d√≠as posparto)",
            profile_nao_gravida: "No Embarazada",
            card_profile: "Perfil",
            card_gestational_age: "Edad Gestacional",
            change_profile: "Cambiar Perfil",
            gestational_age_title: "Edad Gestacional",
            dum_label: "FUM (fecha de √∫ltima menstruaci√≥n)",
            ig_weeks_label: "EG en semanas (si no sabe la FUM)",
            vitals_title: "Signos Vitales (Opcional)",
            symptoms_title: "Signos y S√≠ntomas de Alerta",
            analyze_button: "Analizar Signos",
            result_advice_title: "Recomendaci√≥n y Plan de Acci√≥n:",
            emergency_button: "üö® COMUNICAR EMERGENCIA",
            guide_hemorrhage: "Ver Gu√≠a R√°pida: Hemorragia",
            guide_preeclampsia: "Ver Gu√≠a R√°pida: Preeclampsia",
            summary_title: "Ver resumen para registro",
            copy_summary_button: "Copiar Resumen",
            new_triage_button: "Nuevo Triaje",
            copied: "¬°Copiado!",
            symptom_bleeding: "Sangrado vaginal intenso/co√°gulos",
            symptom_pain: "Dolor abdominal fuerte/contracciones regulares",
            symptom_fluid_loss: "P√©rdida de l√≠quido por la vagina",
            symptom_headache: "Cefalea fuerte/visi√≥n borrosa",
            symptom_seizure: "Convulsi√≥n/desmayo",
            symptom_breathing: "Falta de aire/dolor tor√°cico",
            symptom_fever: "Fiebre alta/escalofr√≠os",
            symptom_urinary_pain: "Dolor al orinar/dolor lumbar",
            symptom_fetal_mov: "Movimientos fetales reducidos (si ‚â•24 sem)",
            symptom_shoulder_pain: "Dolor en el hombro/mareo (sospecha de ect√≥pico)",
            symptom_postpartum_bleeding: "Sangrado anormal en el puerperio",
            symptom_mastitis: "Mama roja/dolorosa con fiebre (mastitis)",
            symptom_vomiting: "V√≥mitos persistentes/incapaz de ingerir l√≠quidos",
        },
        en: {
            app_title: "Obstetric & Gynecological Triage ‚Äî MissionCare Plus",
            main_title: "Obstetric & Gynecological Triage",
            subtitle: "Decision support tool. <strong>Does not replace a medical consultation.</strong>",
            select_profile_title: "1. Select Patient Profile",
            profile_gestante: "Pregnant",
            profile_puerpera: "Postpartum",
            profile_puerpera_subtitle: "(up to 42 days postpartum)",
            profile_nao_gravida: "Not Pregnant",
            card_profile: "Profile",
            card_gestational_age: "Gestational Age",
            change_profile: "Change Profile",
            gestational_age_title: "Gestational Age",
            dum_label: "LMP (last menstrual period)",
            ig_weeks_label: "GA in weeks (if LMP is unknown)",
            vitals_title: "Vital Signs (Optional)",
            symptoms_title: "Warning Signs and Symptoms",
            analyze_button: "Analyze Signs",
            result_advice_title: "Advice and Action Plan:",
            emergency_button: "üö® COMMUNICATE EMERGENCY",
            guide_hemorrhage: "View Quick Guide: Hemorrhage",
            guide_preeclampsia: "View Quick Guide: Preeclampsia",
            summary_title: "View summary for records",
            copy_summary_button: "Copy Summary",
            new_triage_button: "New Triage",
            copied: "Copied!",
            symptom_bleeding: "Heavy vaginal bleeding/clots",
            symptom_pain: "Severe abdominal pain/regular contractions",
            symptom_fluid_loss: "Leaking fluid from vagina",
            symptom_headache: "Severe headache/blurred vision",
            symptom_seizure: "Seizure/fainting",
            symptom_breathing: "Shortness of breath/chest pain",
            symptom_fever: "High fever/chills",
            symptom_urinary_pain: "Painful urination/low back pain",
            symptom_fetal_mov: "Reduced fetal movements (if ‚â•24 wks)",
            symptom_shoulder_pain: "Shoulder pain/dizziness (suspected ectopic)",
            symptom_postpartum_bleeding: "Abnormal postpartum bleeding",
            symptom_mastitis: "Red, painful breast with fever (mastitis)",
            symptom_vomiting: "Persistent vomiting/unable to keep liquids down",
        }
    };
    
    let currentLang = 'pt';

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('gob_triage_lang', lang);
        document.documentElement.lang = lang;
        
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                element.innerHTML = translations[lang][key];
            }
        });

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
        });
    }


    function showPage(pageNumber) {
        Object.values(pages).forEach(p => p.classList.remove('active'));
        pages[pageNumber].classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function selectProfile(profile) {
        state.profile = profile;
        el('card-profile').textContent = profileLabels[currentLang][profile];
        
        const gestanteFields = el('gestante-fields-section');
        const cardIgContainer = el('card-ig-container');
        document.querySelectorAll('.gestanteOnly').forEach(x => x.classList.toggle('hidden', profile !== 'gestante'));
        document.querySelectorAll('.puerperaOnly').forEach(x => x.classList.toggle('hidden', profile !== 'puerpera'));

        if (profile === 'gestante') {
            gestanteFields.classList.remove('hidden');
            cardIgContainer.classList.remove('hidden');
        } else {
            gestanteFields.classList.add('hidden');
            cardIgContainer.classList.add('hidden');
        }
        showPage('2');
    }

    function getIG() {
      let ig = null;
      if (state.profile === 'gestante') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        if (el('dum').value) {
          const d = new Date(el('dum').value);
          d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
          if (!isNaN(d.getTime()) && d <= hoje) {
            ig = Math.max(0, Math.min(43, Math.floor((hoje - d) / (1000 * 60 * 60 * 24 * 7))));
          }
        } else if (el('igSemanas').value) {
          ig = parseInt(el('igSemanas').value, 10);
        }
      }
      state.ig = ig;
      el('card-ig').textContent = (ig != null && !isNaN(ig) ? `${ig} semanas` : '‚Äî');
      return ig;
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function classificar() {
      const sintomas = [...document.querySelectorAll('.sym:checked')].map(x => x.value);
      const sinaisVitais = {
        pas: +(el('pas').value || 0), pad: +(el('pad').value || 0), fc: +(el('fc').value || 0), fr: +(el('fr').value || 0), temp: +(el('temp').value || 0)
      };
      const IG = getIG();
      
      const emergencia = verificarEmergencia(sintomas, state.profile, IG, sinaisVitais);
      if (emergencia) return emergencia;
      
      const urgencia = verificarUrgencia(sintomas, state.profile, IG);
      if (urgencia) return urgencia;
      
      const atencao = verificarAtencao(sintomas);
      if (atencao) return atencao;
      
      return { 
        nivel: 'üü¢ Verde ‚Äî N√£o Urgente', 
        classe: 'border-emerald-500 bg-emerald-50',
        plano: [
          '<strong>Conduta:</strong> Manter acompanhamento de rotina (pr√©-natal ou ginecol√≥gico).',
          '<strong>Autocuidado:</strong> Focar em descanso, hidrata√ß√£o e alimenta√ß√£o saud√°vel.',
          '<strong>Sinais de Alerta:</strong> Observar surgimento de sangramento, piora da dor, febre, desmaio ou falta de ar.'
        ]
      };
    }

    function verificarEmergencia(sintomas, perfil, IG, sinaisVitais) {
      const hemoGrave = (sinaisVitais.pas && sinaisVitais.pas < 90) || (sinaisVitais.pas && sinaisVitais.pas >= 160) || (sinaisVitais.pad && sinaisVitais.pad >= 110) || (sinaisVitais.fc && sinaisVitais.fc > 120) || (sinaisVitais.fr && sinaisVitais.fr > 30) || (sinaisVitais.temp && sinaisVitais.temp >= 38.5);
      const after20w = IG != null && IG >= 20;
      if (hemoGrave || sintomas.includes('convulsao') || sintomas.includes('dispneia_toracica') || sintomas.includes('sangramento_intenso') || (perfil === 'gestante' && sintomas.includes('dor_abdominal_forte') && IG != null && IG < 12 && sintomas.includes('ombro_dor')) || (perfil === 'gestante' && after20w && sintomas.includes('cefaleia_visao') && ((sinaisVitais.pas && sinaisVitais.pas >= 140) || (sinaisVitais.pad && sinaisVitais.pad >= 90))) || (perfil === 'puerpera' && sintomas.includes('sangramento_puerperio'))) {
        return { nivel: 'üî¥ Vermelho ‚Äî Emerg√™ncia', classe: 'border-red-500 bg-red-50', plano: ['<strong>A√ß√£o Imediata:</strong> Levar a paciente ao servi√ßo de sa√∫de mais pr√≥ximo AGORA.', '<strong>Transporte:</strong> Se poss√≠vel, n√£o ir sozinha. Levar cart√£o pr√©-natal e exames.', '<strong>Cuidados:</strong> Manter repouso e n√£o ingerir alimentos s√≥lidos.'], isEmergency: true };
      }
      return null;
    }

    function verificarUrgencia(sintomas, perfil, IG) {
      const after24w = IG != null && IG >= 24;
      if ((perfil === 'gestante' && sintomas.includes('perda_liquido') && IG != null && IG < 37) || (perfil === 'gestante' && after24w && sintomas.includes('mov_fetais_reduzidos')) || (sintomas.includes('febre_alta') && sintomas.includes('disuria_lombar')) || (perfil === 'puerpera' && (sintomas.includes('mastite') || sintomas.includes('febre_alta')))) {
        return { nivel: 'üü† Laranja ‚Äî Urg√™ncia', classe: 'border-orange-500 bg-orange-50', plano: ['<strong>A√ß√£o:</strong> Procurar avalia√ß√£o m√©dica ou teleconsulta nas pr√≥ximas horas (idealmente ‚â§ 24h).', '<strong>Monitoramento:</strong> Observar atentamente a evolu√ß√£o dos sintomas.', '<strong>Alerta:</strong> Em caso de piora, tratar como emerg√™ncia (Vermelho).'], isUrgency: true };
      }
      return null;
    }

    function verificarAtencao(sintomas) {
      if (sintomas.includes('vomitos_persistentes') || sintomas.includes('disuria_lombar') || sintomas.includes('dor_abdominal_forte')) {
        return { nivel: 'üü° Amarelo ‚Äî Aten√ß√£o', classe: 'border-yellow-400 bg-yellow-50', plano: ['<strong>A√ß√£o:</strong> Agendar avalia√ß√£o ambulatorial ou teleconsulta (em at√© 72h).', '<strong>Autocuidado:</strong> Manter boa hidrata√ß√£o e repouso.', '<strong>Observar:</strong> Ficar atenta a sinais de alarme para reclassifica√ß√£o.'] };
      }
      return null;
    }

    function montarResumo(nivel) {
      const sintomas = [...document.querySelectorAll('.sym:checked')].map(checkbox => {
          const label = checkbox.nextElementSibling;
          return label ? label.textContent.trim() : checkbox.value;
      });
      const p = profileLabels[currentLang][state.profile];
      const vitais = [
        el('pas').value ? `PA: ${el('pas').value}x${el('pad').value} mmHg` : '',
        el('fc').value ? `FC: ${el('fc').value} bpm` : '',
        el('fr').value ? `FR: ${el('fr').value} irpm` : '',
        el('temp').value ? `T: ${el('temp').value}¬∞C` : ''
      ].filter(Boolean).join(', ');

      const resumo = [
        `PERFIL: ${p}`,
        (state.profile === 'gestante' ? `IG ESTIMADA: ${el('card-ig').textContent}` : ''),
        `SINAIS VITAIS: ${vitais || 'n√£o aferidos'}`,
        `SINTOMAS: ${sintomas.join('; ') || 'nenhum relatado'}`,
        `CLASSIFICA√á√ÉO: ${nivel}`
      ].filter(Boolean).join('\n');
      state.summary = resumo;
      return resumo;
    }
    
    function setupEmergencyActions() {
        const cleanSummary = state.summary.replace(/\n/g, ' ').replace(/PERFIL:.*SINAIS VITAIS:/, 'SINAIS VITAIS:');
        const text = encodeURIComponent(`ALERTA C√ìDIGO MATER: ${cleanSummary}. Necessita de remo√ß√£o IMEDIATA. Local: [INFORMAR LOCAL].`);
        el('comunicar-emergencia-btn').href = `https://api.whatsapp.com/message/DY63DAZ7BSHKL1?autoload=1&app_absent=0&text=${text}`;
    }

    function resetApp() {
        document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
        ['pas', 'pad', 'fc', 'fr', 'temp', 'dum', 'igSemanas'].forEach(id => el(id).value = '');
        state.profile = null;
        state.ig = null;
        state.summary = '';
        showPage('1');
    }

    el('analisarBtn').addEventListener('click', () => {
      const r = classificar();
      el('resultado').className = 'rounded-2xl p-5 border-4 ' + r.classe;
      el('nivel').innerHTML = r.nivel;
      el('aconselhamento').innerHTML = '<ul class="space-y-1">' + r.plano.map(x => `<li>${x}</li>`).join('') + '</ul>';
      el('resumo').textContent = montarResumo(r.nivel);

      el('emergency-actions').classList.toggle('hidden', !r.isEmergency);
      el('other-actions').classList.toggle('hidden', !r.isUrgency);
      
      if(r.isEmergency) {
          setupEmergencyActions();
      }

      showPage('3');
    });

    el('copiarBtn')?.addEventListener('click', () => { 
      navigator.clipboard.writeText(state.summary);
      const btn = el('copiarBtn');
      const originalText = btn.textContent;
      btn.textContent = translations[currentLang].copied || "Copied!";
      btn.classList.add('bg-green-600');
      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('bg-green-600');
      }, 2000);
    });

    ['dum', 'igSemanas'].forEach(id => {
      el(id).addEventListener('input', debounce(getIG, 300));
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        const savedLang = localStorage.getItem('gob_triage_lang') || 'pt';
        setLanguage(savedLang);
        showPage('1');
    });
  </script>
</body>
</html>
