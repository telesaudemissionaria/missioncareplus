<!DOCTYPE html>
<html lang="pt-BR" id="html-lang">
    // Prefer shared translator dictionaries; local fallback removed to centralize translations
    const translations = window.translations || {};

    // --- LÓGICA DE INTERNACIONALIZAÇÃO (i18n) ---
    let currentLang = localStorage.getItem('lang') || 'pt';

    const setLanguage = (lang) => {
        if (!lang) return;
        currentLang = lang;
        document.documentElement.lang = lang;

        // Prefer central translator when available
        if (window.applyTranslations) {
            window.applyTranslations(lang);
            return;
        }

        if (translations[lang]) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = translations[lang][key] || el.innerHTML;
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[lang][key] || el.placeholder;
            });

            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
        }
    };
            <span data-i18n="navAnalyze" class="text-xs font-medium">Gerar Análise</span>
        </button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // load shared translator if available
    const s = document.createElement('script'); s.src = 'assets/js/translator.js'; s.defer = true; document.head.appendChild(s);
    s.addEventListener('load', () => {
        if (window.Translator && typeof window.Translator.init === 'function') {
            window.Translator.init({ storageKey: 'lang', defaultLang: 'pt' });
        }
    });

    // --- DEFINIÇÃO DAS TRADUÇÕES ---
    const translations = {
        en: {
            pageTitle: "Simplified Anamnesis - MissionCare Plus",
            headerTitle: "Adult Anamnesis",
            emergencyWarning: "ATTENTION: IN CASE OF EMERGENCY, SEEK HELP IMMEDIATELY.",
            q1Title: "1. What is the main problem or symptom?",
            q1Placeholder: "Ex: Severe headache, high fever...",
            q2Title: "2. When exactly did the symptoms start?",
            q2Placeholder: "Ex: 3 days ago, last night",
            q3Title: "3. Are the symptoms getting better, worse, or staying the same?",
            q3Opt1: "Getting better",
            q3Opt2: "Getting worse",
            q3Opt3: "Staying the same",
            q4Title: "4. What makes the symptom better or worse?",
            q4Placeholder: "Ex: Rest improves it, effort worsens it...",
            q5Title: "5. Do you have any of these chronic diseases?",
            q5Opt1: "Hypertension (High blood pressure)",
            q5Opt2: "Diabetes",
            q5Opt3: "Asthma",
            q5Opt4: "Heart Disease",
            q5Opt5: "None of the above",
            q6Title: "6. Do you use any medication continuously?",
            q6Placeholder: "Ex: Losartan 50mg, Metformin...",
            q7Title: "7. Do you have any known allergies?",
            q7Placeholder: "Ex: Allergic to Penicillin, shrimp...",
            resultsTitle: "Analysis Recommendations",
            navHome: "HOME",
            navAnalyze: "Analyze",
            loading: "Analyzing information...",
            errorTitle: "ERROR: Could not process analysis.",
            errorMessage: "There was a problem communicating with the server. Please try again later.",
        },
        es: {
            pageTitle: "Anamnesis Simplificada - MissionCare Plus",
            headerTitle: "Anamnesis Adulto",
            emergencyWarning: "ATENCIÓN: EN CASO DE EMERGENCIA, BUSQUE AYUDA INMEDIATAMENTE.",
            q1Title: "1. ¿Cuál es el principal problema o síntoma?",
            q1Placeholder: "Ej: Dolor de cabeza fuerte, fiebre alta...",
            q2Title: "2. ¿Cuándo empezaron exactamente los síntomas?",
            q2Placeholder: "Ej: Hace 3 días, anoche",
            q3Title: "3. ¿Los síntomas están mejorando, empeorando o siguen igual?",
            q3Opt1: "Mejorando",
            q3Opt2: "Empeorando",
            q3Opt3: "Siguen Igual",
            q4Title: "4. ¿Qué mejora o empeora el síntoma?",
            q4Placeholder: "Ej: El reposo mejora, el esfuerzo empeora...",
            q5Title: "5. ¿Tiene alguna de estas enfermedades crónicas?",
            q5Opt1: "Hipertensión (Presión alta)",
            q5Opt2: "Diabetes",
            q5Opt3: "Asma",
            q5Opt4: "Enfermedad Cardíaca",
            q5Opt5: "Ninguna de las opciones",
            q6Title: "6. ¿Usa algún medicamento de forma continua?",
            q6Placeholder: "Ej: Losartán 50mg, Metformina...",
            q7Title: "7. ¿Tiene alguna alergia conocida?",
            q7Placeholder: "Ej: Alergia a la Penicilina, camarones...",
            resultsTitle: "Recomendaciones del Análisis",
            navHome: "INICIO",
            navAnalyze: "Generar Análisis",
            loading: "Analizando la información...",
            errorTitle: "ERROR: No se pudo procesar el análisis.",
            errorMessage: "Hubo un problema de comunicación con el servidor. Por favor, inténtelo de nuevo más tarde.",
        },
        pt: {
            pageTitle: "Anamnese Simplificada - MissionCare Plus",
            headerTitle: "Anamnese Adulto",
            emergencyWarning: "ATENÇÃO: EM CASO DE EMERGÊNCIA, PROCURE AJUDA IMEDIATAMENTE.",
            q1Title: "1. Qual o principal problema ou sintoma?",
            q1Placeholder: "Ex: Dor de cabeça forte, febre alta...",
            q2Title: "2. Quando exatamente os sintomas começaram?",
            q2Placeholder: "Ex: Há 3 dias, ontem à noite",
            q3Title: "3. Os sintomas estão melhorando, piorando ou iguais?",
            q3Opt1: "Melhorando",
            q3Opt2: "Piorando",
            q3Opt3: "Permanecem Iguais",
            q4Title: "4. O que melhora ou piora o sintoma?",
            q4Placeholder: "Ex: Repouso melhora, esforço piora...",
            q5Title: "5. Possui alguma destas doenças crônicas?",
            q5Opt1: "Hipertensão (Pressão alta)",
            q5Opt2: "Diabetes",
            q5Opt3: "Asma",
            q5Opt4: "Doença Cardíaca",
            q5Opt5: "Nenhuma das opções",
            q6Title: "6. Usa algum medicamento de forma contínua?",
            q6Placeholder: "Ex: Losartana 50mg, Metformina...",
            q7Title: "7. Possui alguma alergia conhecida?",
            q7Placeholder: "Ex: Alergia a Penicilina, camarão...",
            resultsTitle: "Recomendações da Análise",
            navHome: "INÍCIO",
            navAnalyze: "Gerar Análise",
            loading: "Analisando informações...",
            errorTitle: "ERRO: Não foi possível processar a análise.",
            errorMessage: "Houve um problema ao comunicar com o servidor. Por favor, tente novamente mais tarde.",
        }
    };

    // --- LÓGICA DE INTERNACIONALIZAÇÃO (i18n) ---
    let currentLang = 'pt';

    const setLanguage = (lang) => {
        if (!translations[lang]) return;
        currentLang = lang;
        document.documentElement.lang = lang;

        // If shared translator is available, prefer it to update the DOM
        if (window.applyTranslations) {
            window.applyTranslations(lang);
        } else {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = translations[lang][key] || el.innerHTML;
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[lang][key] || el.placeholder;
            });

            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
        }
    };

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            setLanguage(e.currentTarget.dataset.lang);
        });
    });


    // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---
    const formScreen = document.getElementById('form-screen');
    const resultsScreen = document.getElementById('results-screen');
    const generateBtn = document.getElementById('nav-generate-report-btn');
    const backBtn = document.getElementById('back-to-form-btn');
    const orientationContent = document.getElementById('orientation-content');

    generateBtn.addEventListener('click', async () => {
        const getSelectedValues = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
        
        const reportData = {
            'Problema Principal': document.getElementById('problema-principal').value,
            'Início dos Sintomas': document.getElementById('inicio-sintomas').value,
            'Progressão dos Sintomas': document.querySelector('input[name="progressao-sintomas"]:checked')?.value || 'Não informado',
            'O que melhora ou piora?': document.getElementById('melhora-piora').value,
            'Doenças Crônicas': getSelectedValues('condicoes').join(', ') || 'Nenhuma',
            'Medicamentos Contínuos': document.getElementById('medicamentos').value,
            'Alergias': document.getElementById('alergias').value,
        };

        let prompt = "Analise os seguintes dados de anamnese de um paciente adulto e forneça uma orientação clínica detalhada. Classifique a urgência (Baixa, Média, Alta), liste possíveis hipóteses diagnósticas (com justificativa), sugira uma conduta clara (incluindo autocuidado e quando procurar um médico), e liste sinais de alerta específicos que o paciente deve observar. Formate a resposta em markdown.\n\n";
        for (const [key, value] of Object.entries(reportData)) {
            if (value && value !== 'Não informado' && value.length > 0) {
                prompt += `- ${key}: ${value}\n`;
            }
        }

        formScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');
        orientationContent.innerHTML = `<div class="loader mx-auto my-8"></div><p class="text-center font-semibold text-gray-600">${translations[currentLang].loading}</p>`;

        try {
            const response = await fetch('https://missioncareplus-jca0.onrender.com/api/v1/assistente', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tipo_assistente: 'clinica',
                    prompt: prompt
                })
            });

            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`Server error: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            if (data.response) {
                 orientationContent.innerHTML = window.marked.parse(data.response);
            } else {
                 throw new Error("API response in unexpected format.");
            }

        } catch (error) {
            console.error('Error generating report:', error);
            orientationContent.innerHTML = `<div class="text-center p-4 bg-red-100 text-red-800 rounded-lg">
                                                <p class="font-bold">${translations[currentLang].errorTitle}</p>
                                                <p class="mt-2">${translations[currentLang].errorMessage}</p>
                                                <p class="text-sm mt-2">Detail: ${error.message}</p>
                                            </div>`;
        }
    });

    backBtn.addEventListener('click', () => {
        resultsScreen.classList.add('hidden');
        formScreen.classList.remove('hidden');
        orientationContent.innerHTML = '';
    });

    // --- INICIALIZAÇÃO ---
    setLanguage(currentLang);
});
</script>
</body>
</html>
