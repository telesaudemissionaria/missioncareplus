<!DOCTYPE html>
<html lang="pt-BR" id="html-lang">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-i18n="pageTitle">Anamnese Simplificada - MissionCare Plus</title>
    <link rel="stylesheet" href="style.css">
    <script src="assets/js/translator.js" defer></script>
</head>
<body class="bg-white text-gray-900">

<main class="max-w-3xl mx-auto p-4">
    <header class="mb-4">
        <h1 data-i18n="headerTitle" class="text-2xl font-bold">Anamnese Adulto</h1>
        <p data-i18n="emergencyWarning" class="text-sm text-red-700 mt-2">ATENÇÃO: EM CASO DE EMERGÊNCIA, PROCURE AJUDA IMEDIATAMENTE.</p>
    </header>

    <section id="form-screen" aria-labelledby="form-title">
        <h2 id="form-title" class="sr-only">Formulário de Anamnese</h2>

        <form id="triagem-form" autocomplete="on">
            <div class="mb-4">
                <label for="problema-principal" data-i18n="q1Title" class="block font-medium">1. Qual o principal problema ou sintoma?</label>
                <textarea id="problema-principal" rows="3" data-i18n-placeholder="q1Placeholder" placeholder="Ex: Dor de cabeça forte, febre alta..." class="w-full border rounded p-2"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="inicio-sintomas" data-i18n="q2Title" class="block font-medium">2. Quando exatamente os sintomas começaram?</label>
                    <input id="inicio-sintomas" type="text" data-i18n-placeholder="q2Placeholder" placeholder="Ex: Há 3 dias, ontem à noite" class="w-full border rounded p-2" />
                </div>

                <div>
                    <fieldset>
                        <legend data-i18n="q3Title" class="font-medium">3. Os sintomas estão melhorando, piorando ou iguais?</legend>
                        <div class="flex gap-2 mt-2">
                            <label><input type="radio" name="progressao-sintomas" value="Melhorando"> <span data-i18n="q3Opt1">Melhorando</span></label>
                            <label><input type="radio" name="progressao-sintomas" value="Piorando"> <span data-i18n="q3Opt2">Piorando</span></label>
                            <label><input type="radio" name="progressao-sintomas" value="Permanecem Iguais"> <span data-i18n="q3Opt3">Permanecem Iguais</span></label>
                        </div>
                    </fieldset>
                </div>
            </div>

            <div class="mb-4 mt-4">
                <label for="melhora-piora" data-i18n="q4Title" class="block font-medium">4. O que melhora ou piora o sintoma?</label>
                <input id="melhora-piora" type="text" data-i18n-placeholder="q4Placeholder" placeholder="Ex: Repouso melhora, esforço piora..." class="w-full border rounded p-2" />
            </div>

            <div class="mb-4">
                <label class="block font-medium" data-i18n="q5Title">5. Possui alguma destas doenças crônicas?</label>
                <div class="flex flex-wrap gap-2 mt-2" role="group" aria-label="Condições crônicas">
                    <label><input type="checkbox" name="condicoes" value="Hipertensão"> <span data-i18n="q5Opt1">Hipertensão</span></label>
                    <label><input type="checkbox" name="condicoes" value="Diabetes"> <span data-i18n="q5Opt2">Diabetes</span></label>
                    <label><input type="checkbox" name="condicoes" value="Asma"> <span data-i18n="q5Opt3">Asma</span></label>
                    <label><input type="checkbox" name="condicoes" value="Doença Cardíaca"> <span data-i18n="q5Opt4">Doença Cardíaca</span></label>
                    <label><input type="checkbox" name="condicoes" value="Nenhuma"> <span data-i18n="q5Opt5">Nenhuma das opções</span></label>
                </div>
            </div>

            <div class="mb-4">
                <label for="medicamentos" data-i18n="q6Title" class="block font-medium">6. Usa algum medicamento de forma contínua?</label>
                <input id="medicamentos" type="text" data-i18n-placeholder="q6Placeholder" placeholder="Ex: Losartana 50mg, Metformina..." class="w-full border rounded p-2" />
            </div>

            <div class="mb-6">
                <label for="alergias" data-i18n="q7Title" class="block font-medium">7. Possui alguma alergia conhecida?</label>
                <input id="alergias" type="text" data-i18n-placeholder="q7Placeholder" placeholder="Ex: Alergia a Penicilina, camarão..." class="w-full border rounded p-2" />
            </div>

            <div class="flex gap-2 items-center">
                <button type="button" id="nav-generate-report-btn" class="btn-primary px-4 py-2" aria-live="polite">
                    <span data-i18n="navAnalyze">Gerar Análise</span>
                </button>
                <button type="button" id="restore-draft-btn" class="btn-secondary px-3 py-2 text-sm hidden">Restaurar rascunho</button>
            </div>
        </form>
    </section>

    <section id="results-screen" class="hidden mt-6" aria-labelledby="results-title">
        <h2 id="results-title" class="sr-only">Resultados</h2>
        <div id="orientation-content" role="region" aria-live="polite" aria-atomic="true"></div>
        <div class="mt-4">
            <button id="back-to-form-btn" class="btn-link">Voltar</button>
        </div>
    </section>

</main>

<script>
/* Consolidated script for triagem adulto: i18n fallback, fetch with timeout, disable/enable UI, autosave */
(function (){
    const DRAFT_KEY = 'triagem_adulto_draft';
    const API_URL = 'https://missioncareplus-jca0.onrender.com/api/v1/assistente';
    const TIMEOUT_MS = 15000; // 15s

    // Utilities
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const debounce = (fn, wait=300) => {
        let t;
        return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
    };

    // i18n: prefer shared translator, fallback to minimal local map
    const localStrings = {
        loading: 'Analisando informações...',
        errorTitle: 'ERRO: Não foi possível processar a análise.',
        errorMessage: 'Houve um problema ao comunicar com o servidor. Por favor, tente novamente mais tarde.'
    };

    const getString = (key) => {
        if (window.translations && window.currentLang) {
            return (window.translations[window.currentLang] && window.translations[window.currentLang][key]) || localStrings[key] || key;
        }
        return localStrings[key] || key;
    };

    // Elements
    const form = $('#triagem-form');
    const formScreen = $('#form-screen');
    const resultsScreen = $('#results-screen');
    const generateBtn = $('#nav-generate-report-btn');
    const backBtn = $('#back-to-form-btn');
    const orientationContent = $('#orientation-content');
    const restoreBtn = $('#restore-draft-btn');

    // Load translator if present
    document.addEventListener('DOMContentLoaded', () => {
        if (window.Translator && typeof window.Translator.init === 'function') {
            window.Translator.init({ storageKey: 'lang', defaultLang: 'pt' });
        }

        // Restore draft if exists
        const draft = localStorage.getItem(DRAFT_KEY);
        if (draft) {
            restoreBtn.classList.remove('hidden');
            restoreBtn.addEventListener('click', () => {
                try { const data = JSON.parse(draft); for (const [k,v] of Object.entries(data)) { const el = document.getElementById(k); if (el) el.value = v; } restoreBtn.classList.add('hidden'); }
                catch(e){ console.warn('Could not restore draft', e); }
            });
        }

        // Wire autosave
        const inputs = $$('input, textarea');
        const saveDraft = debounce(()=>{
            const state = {};
            inputs.forEach(i => state[i.id || i.name] = i.value || '');
            try { localStorage.setItem(DRAFT_KEY, JSON.stringify(state)); restoreBtn.classList.remove('hidden'); } catch(e){/* ignore */}
        }, 400);
        inputs.forEach(i => i.addEventListener('input', saveDraft));
    });

    // Fetch with timeout using AbortController
    const fetchWithTimeout = (url, opts={}, timeout=TIMEOUT_MS) => {
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), timeout);
        return fetch(url, Object.assign({}, opts, { signal: controller.signal })).finally(()=>clearTimeout(id));
    };

    // Helper to collect form data
    const getSelectedValues = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);

    // Main generate handler
    generateBtn.addEventListener('click', async () => {
        // Lightweight validation
        const problema = document.getElementById('problema-principal').value.trim();
        if (!problema) { alert('Por favor, descreva o problema principal.'); document.getElementById('problema-principal').focus(); return; }

        // Build report
        const reportData = {
            'Problema Principal': problema,
            'Início dos Sintomas': document.getElementById('inicio-sintomas').value.trim(),
            'Progressão dos Sintomas': document.querySelector('input[name="progressao-sintomas"]:checked')?.value || 'Não informado',
            'O que melhora ou piora?': document.getElementById('melhora-piora').value.trim(),
            'Doenças Crônicas': getSelectedValues('condicoes').join(', ') || 'Nenhuma',
            'Medicamentos Contínuos': document.getElementById('medicamentos').value.trim(),
            'Alergias': document.getElementById('alergias').value.trim(),
        };

        let prompt = "Analise os seguintes dados de anamnese de um paciente adulto e forneça uma orientação clínica detalhada. Classifique a urgência (Baixa, Média, Alta), liste possíveis hipóteses diagnósticas (com justificativa), sugira uma conduta clara (incluindo autocuidado e quando procurar um médico), e liste sinais de alerta específicos que o paciente deve observar. Formate a resposta em markdown.\n\n";
        for (const [key, value] of Object.entries(reportData)) {
            if (value && value !== 'Não informado' && value.length > 0) {
                prompt += `- ${key}: ${value}\n`;
            }
        }

        // UI state: disable button, show loader, hide form
        generateBtn.disabled = true;
        generateBtn.setAttribute('aria-busy','true');
        formScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');
        orientationContent.innerHTML = `<div class="loader mx-auto my-8"></div><p class="text-center font-semibold text-gray-600">${getString('loading') || 'Analisando...'}</p>`;

        try {
            const res = await fetchWithTimeout(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tipo_assistente: 'clinica', prompt })
            }, TIMEOUT_MS);

            if (!res.ok) {
                const text = await res.text().catch(()=>res.statusText || '');
                throw new Error(`Server error: ${res.status} ${text}`);
            }
            const data = await res.json();
            if (data.response) {
                // Use marked if available, else preformatted text
                if (window.marked && typeof window.marked.parse === 'function') orientationContent.innerHTML = window.marked.parse(data.response);
                else orientationContent.innerHTML = `<pre>${escapeHtml(data.response)}</pre>`;
                // Clear draft on successful generation
                try { localStorage.removeItem(DRAFT_KEY); restoreBtn.classList.add('hidden'); } catch(e){}
            } else {
                throw new Error('API returned unexpected payload');
            }

        } catch (err) {
            console.error('Error generating report:', err);
            orientationContent.innerHTML = `<div class="text-center p-4 bg-red-100 text-red-800 rounded-lg">
                <p class="font-bold">${getString('errorTitle')}</p>
                <p class="mt-2">${getString('errorMessage')}</p>
                <p class="text-sm mt-2">Detalhe: ${escapeHtml(err.message || String(err))}</p>
                <div class="mt-3"><button id="retry-btn" class="btn-primary px-3 py-1">Tentar novamente</button></div>
            </div>`;
            // Wire retry
            const retry = $('#retry-btn');
            if (retry) retry.addEventListener('click', ()=> generateBtn.click());
        } finally {
            generateBtn.disabled = false;
            generateBtn.removeAttribute('aria-busy');
        }
    });

    backBtn.addEventListener('click', () => {
        resultsScreen.classList.add('hidden');
        formScreen.classList.remove('hidden');
        orientationContent.innerHTML = '';
    });

    // small helper to escape HTML when marked isn't available
    function escapeHtml(str){ return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

})();
</script>

</body>
</html>